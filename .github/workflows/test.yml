name: Java CI with Maven

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        java: [ '11', '17' ]
      fail-fast: false

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK ${{ matrix.java }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java }}
        distribution: 'temurin'
        cache: maven
    
    - name: Build with Maven
      run: mvn -B clean install --file pom.xml -Dmaven.javadoc.skip=true
    
    - name: Run tests
      run: mvn -B test --file pom.xml
    
    - name: Prepare executable JAR
      run: |
        if ls target/*.jar 1> /dev/null 2>&1; then
          if ls target/*.jar | grep -v "original" > /dev/null; then
            JAR_FILE=$(ls target/*.jar | grep -v "original" | head -1)
          else
            JAR_FILE=$(ls target/*.jar | head -1)
          fi
          
          echo "Selected JAR: $JAR_FILE"
          cp "$JAR_FILE" ./app.jar
          
          MAIN_CLASS=$(unzip -p ./app.jar META-INF/MANIFEST.MF 2>/dev/null | grep "Main-Class:" || echo "")
          if [ -z "$MAIN_CLASS" ]; then
            echo "⚠️ Warning: No Main-Class found in manifest. The JAR may not be executable."
          else
            echo "✅ Found Main-Class: $MAIN_CLASS"
          fi
        else
          echo "❌ No JAR files found in target directory"
          exit 1
        fi
    
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-jar-java-${{ matrix.java }}
        path: ./app.jar

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: app-jar-java-17  # Using Java 17 for deployment
        path: ./
    
    - name: Verify JAR is executable
      run: |
        if [ ! -f app.jar ]; then
          echo "❌ app.jar not found!"
          ls -la
          exit 1
        fi
        
        MAIN_CLASS=$(unzip -p app.jar META-INF/MANIFEST.MF 2>/dev/null | grep "Main-Class:" || echo "")
        if [ -z "$MAIN_CLASS" ]; then
          echo "❌ No Main-Class found in manifest. JAR is not executable."
          exit 1
        else
          echo "✅ Found Main-Class: $MAIN_CLASS"
        fi
    
    - name: Run JAR file and capture output
      run: |
        echo "=== Running JAR file ==="
        # Run the JAR and capture both stdout and stderr
        java -jar app.jar > app.log 2>&1
        EXIT_CODE=$?
        
        # Display the output
        echo "=== Application Output ==="
        cat app.log
        
        if [ $EXIT_CODE -eq 0 ]; then
          echo "✅ Application executed successfully with exit code: $EXIT_CODE"
          
          # Verify expected output
          if grep -q "Hello World!!!" app.log; then
            echo "✅ Found expected output: 'Hello World!!!'"
          else
            echo "⚠️ Expected output 'Hello World!!!' not found in application log"
          fi
          
          if grep -q "Main-Class: org.pirola.maven.example.MavenExample" app.log; then
            echo "✅ Found Main-Class in manifest output"
          else
            echo "⚠️ Main-Class information not found in application log"
          fi
        else
          echo "❌ Application failed with exit code: $EXIT_CODE"
          exit 1
        fi
    
    # Optional: If you want to run the JAR in a different way or with arguments
    - name: Run JAR with arguments (example)
      run: |
        echo "=== Running JAR with arguments ==="
        java -jar app.jar --some-argument > app-with-args.log 2>&1
        echo "=== Output with arguments ==="
        cat app-with-args.log
