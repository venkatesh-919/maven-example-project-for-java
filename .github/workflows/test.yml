name: Java CI with Maven

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        java: [ '11', '17' ]  # Test on multiple Java versions
      fail-fast: false

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK ${{ matrix.java }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java }}
        distribution: 'temurin'
        cache: maven
    
    - name: Build with Maven
      run: mvn -B clean install --file pom.xml -Dmaven.javadoc.skip=true
    
    - name: Run tests
      run: mvn -B test --file pom.xml
    
    - name: Upload test results
      if: always()  # Runs even if tests fail
      uses: actions/upload-artifact@v4
      with:
        name: test-results-java-${{ matrix.java }}
        path: target/surefire-reports/
    
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: maven-example-jar-java-${{ matrix.java }}
        path: target/*.jar

 
    - name: Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: maven-example-jar-java-${{ matrix.java }}  # Note: This needs a specific Java version
        path: ./app
    
    # Alternative: Download all artifacts and find the JAR
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
    
    - name: Find and prepare JAR file
      run: |
        # Find the JAR file (assuming it's the only one or you have a naming convention)
        JAR_FILE=$(find ./artifacts -name "*.jar" | head -n 1)
        if [ -z "$JAR_FILE" ]; then
          echo "No JAR file found!"
          exit 1
        fi
        echo "Found JAR: $JAR_FILE"
        cp "$JAR_FILE" ./app.jar
    
    - name: Run JAR file
      run: |
        # Start the application in background
        java -jar app.jar &
        APP_PID=$!
        echo "APP_PID=$APP_PID" >> $GITHUB_ENV
        
        # Give the app time to start
        sleep 15
    
    - name: Verify application is running
      run: |
        # Check if process is still running
        if ps -p $APP_PID > /dev/null; then
          echo "✅ Application process is running with PID: $APP_PID "
        else
          echo "❌ Application process failed to start or crashed "
          exit 1
        fi
        
        # Check if application is responding (adjust URL and port as needed)
        # Common endpoints to check:
        # - Spring Boot: http://localhost:8080/actuator/health
        # - Default: http://localhost:8080
        # - Custom: http://localhost:YOUR_PORT/YOUR_ENDPOINT
        
        MAX_RETRIES=10
        RETRY_COUNT=0
        APP_URL="http://localhost:8080"  # Change this to your app's URL
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          if curl -f -s -o /dev/null "$APP_URL"; then
            echo "✅ Application is responding at $APP_URL"
            break
          else
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "❌ Application failed to respond after $MAX_RETRIES attempts"
              exit 1
            fi
            echo "Waiting for application to respond... (attempt $RETRY_COUNT/$MAX_RETRIES)"
            sleep 5
          fi
        done
    
    - name: Check application health (Spring Boot specific)
      run: |
        # If using Spring Boot with Actuator
        HEALTH_URL="http://localhost:8080/actuator/health"
        if curl -f -s "$HEALTH_URL" | grep -q '"status":"UP"'; then
          echo "✅ Application health check passed"
        else
          echo "⚠️ Health check endpoint not available or returned non-UP status"
          # Don't fail the build for this, just informational
        fi
    
    - name: Application logs (if available)
      if: always()  # Show logs even if verification fails
      run: |
        echo "=== Application Logs ==="
        # If your app writes logs to a file, display them here
        # tail -n 50 ./app/logs/application.log
        
    - name: Stop application
      if: always()  # Always try to stop the app
      run: |
        if [ ! -z "$APP_PID" ] && ps -p $APP_PID > /dev/null; then
          echo "Stopping application with PID: $APP_PID"
          kill $APP_PID
          # Give it time to shut down gracefully
          sleep 5
          # Force kill if still running
          if ps -p $APP_PID > /dev/null; then
            echo "Force killing application"
            kill -9 $APP_PID
          fi
          echo "✅ Application stopped"
        fi
  # # Optional: Deploy to actual server/cloud
  # deploy-to-server:
  #   needs: build
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
  #   environment: production  # Optional: Define environment
    
  #   steps:
  #   - name: Download JAR artifact
  #     uses: actions/download-artifact@v4
  #     with:
  #       name: maven-example-jar-java-17  # Deploy Java 17 version
  #       path: ./
    
  #   - name: Deploy to server (example with SCP)
  #     env:
  #       SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  #       REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
  #       REMOTE_USER: ${{ secrets.REMOTE_USER }}
  #       REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
  #     run: |
  #       # Setup SSH
  #       mkdir -p ~/.ssh
  #       echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
  #       chmod 600 ~/.ssh/id_rsa
  #       ssh-keyscan -H $REMOTE_HOST >> ~/.ssh/known_hosts
        
  #       # Copy JAR file
  #       scp target/*.jar $REMOTE_USER@$REMOTE_HOST:$REMOTE_PATH/
        
  #       # Restart application on remote server
  #       ssh $REMOTE_USER@$REMOTE_HOST "cd $REMOTE_PATH && ./restart-app.sh"
        
  #   - name: Verify remote deployment
  #     env:
  #       REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
  #       APP_URL: "http://your-app-url.com/health"  # Change to your app URL
  #     run: |
  #       # Wait for app to start
  #       sleep 30
        
  #       # Check if app is responding
  #       if curl -f -s -o /dev/null "$APP_URL"; then
  #         echo "✅ Application deployed successfully and is responding"
  #       else
  #         echo "❌ Application deployment verification failed"
  #         exit 1
        # fi--
