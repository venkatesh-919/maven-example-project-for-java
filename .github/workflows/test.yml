name: Java CI with Maven

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        java: [ '11', '17' ]
      fail-fast: false

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK ${{ matrix.java }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java }}
        distribution: 'temurin'
        cache: maven
    
    - name: Build with Maven
      run: mvn -B clean install --file pom.xml -Dmaven.javadoc.skip=true
    
    - name: Run tests
      run: mvn -B test --file pom.xml
    
    - name: Prepare executable JAR
      run: |
        # Find the executable JAR (for Spring Boot, it's typically not the original)
        if ls target/*.jar 1> /dev/null 2>&1; then
          # For Spring Boot, exclude the original JAR if it exists
          if ls target/*.jar | grep -v "original" > /dev/null; then
            JAR_FILE=$(ls target/*.jar | grep -v "original" | head -1)
          else
            JAR_FILE=$(ls target/*.jar | head -1)
          fi
          
          echo "Selected JAR: $JAR_FILE"
          cp "$JAR_FILE" ./app.jar
          
          # Verify the JAR has a main manifest
          MAIN_CLASS=$(unzip -p ./app.jar META-INF/MANIFEST.MF 2>/dev/null | grep "Main-Class:" || echo "")
          if [ -z "$MAIN_CLASS" ]; then
            echo "⚠️ Warning: No Main-Class found in manifest. The JAR may not be executable."
          else
            echo "✅ Found Main-Class: $MAIN_CLASS"
          fi
        else
          echo "❌ No JAR files found in target directory"
          exit 1
        fi
    
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-jar-java-${{ matrix.java }}
        path: ./app.jar

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: app-jar-java-17  # Using Java 17 for deployment
        path: ./
    
    - name: Verify JAR is executable
      run: |
        if [ ! -f app.jar ]; then
          echo "❌ app.jar not found!"
          ls -la
          exit 1
        fi
        
        # Check manifest
        MAIN_CLASS=$(unzip -p app.jar META-INF/MANIFEST.MF 2>/dev/null | grep "Main-Class:" || echo "")
        if [ -z "$MAIN_CLASS" ]; then
          echo "❌ No Main-Class found in manifest. JAR is not executable."
          exit 1
        else
          echo "✅ Found Main-Class: $MAIN_CLASS"
        fi
    
    - name: Run JAR file
      run: |
        # Start the application in background with output redirected to a log file
        java -jar app.jar > app.log 2>&1 &
        APP_PID=$!
        echo "APP_PID=$APP_PID" >> $GITHUB_ENV
        
        echo "Started application with PID: $APP_PID"
        
        # Give the app time to start
        sleep 15
    
    - name: Check if application is running
      run: |
        if ps -p $APP_PID > /dev/null; then
          echo "✅ Application process is running with PID: $APP_PID"
          
          # Show last few lines of log
          echo "=== Last 20 lines of application log ==="
          tail -20 app.log
        else
          echo "❌ Application process failed to start or crashed"
          echo "=== Application log ==="
          cat app.log
          exit 1
        fi
    
    - name: Verify application health
      run: |
        MAX_RETRIES=10
        RETRY_COUNT=0
        APP_URL="http://localhost:8080"
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          if curl -f -s -o /dev/null "$APP_URL"; then
            echo "✅ Application is responding at $APP_URL"
            break
          else
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "❌ Application failed to respond after $MAX_RETRIES attempts"
              echo "=== Application log ==="
              cat app.log
              exit 1
            fi
            echo "Waiting for application to respond... (attempt $RETRY_COUNT/$MAX_RETRIES)"
            sleep 5
          fi
        done
    
    - name: Stop application
      if: always()
      run: |
        if [ ! -z "$APP_PID" ] && ps -p $APP_PID > /dev/null; then
          echo "Stopping application with PID: $APP_PID"
          kill $APP_PID
          sleep 5
          if ps -p $APP_PID > /dev/null; then
            echo "Force killing application"
            kill -9 $APP_PID
          fi
          echo "✅ Application stopped"
        fi
        
